<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KenariCoin Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Web3Modal v2 (popup universal wallet) -->
  <script src="https://unpkg.com/@web3modal/html@2.7.1"></script>

  <!-- Ethers.js v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <link rel="icon" href="img/logo.png" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FACC15" />

  <style>
    .page-section { opacity:0; transform:translateY(10px); transition:opacity .35s ease,transform .35s ease; display:none; }
    .page-section.active { display:block; opacity:1; transform:translateY(0); }
    .glow-hover:hover { box-shadow:0 0 12px rgba(250,204,21,.7); transition:box-shadow .25s ease; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

  <!-- NAVBAR -->
  <nav class="bg-gray-800 shadow fixed w-full z-30 top-0 border-b border-gray-700">
    <div class="max-w-7xl mx-auto px-4 flex items-center justify-between h-16">
      <!-- LEFT -->
      <div class="flex items-center gap-3">
        <button id="menuBtn" class="md:hidden p-2 rounded hover:bg-gray-700" onclick="toggleMenu()" aria-label="Open menu">☰</button>
        <img src="img/logo.png" alt="Logo" class="w-10 h-10 rounded-full">
        <span class="font-bold text-lg text-yellow-400 block md:hidden">KN</span>
        <span class="font-bold text-lg text-yellow-400 hidden md:block">KenariCoin</span>
      </div>

      <!-- CENTER NAV -->
      <div id="navLinks" class="hidden md:flex space-x-6">
        <a href="#" onclick="navigate('home')" class="hover:text-yellow-400" data-i18n="home">Home</a>
        <a href="#" onclick="navigate('wallet')" class="hover:text-yellow-400" data-i18n="wallet">Wallet</a>
        <a href="#" onclick="navigate('staking')" class="hover:text-yellow-400" data-i18n="staking">Staking</a>
        <a href="#" onclick="navigate('about')" class="hover:text-yellow-400" data-i18n="about">About</a>
        <a href="#" onclick="navigate('contact')" class="hover:text-yellow-400" data-i18n="contact">Contact</a>
        <a href="#" onclick="navigate('faq')" class="hover:text-yellow-400" data-i18n="faq">FAQ</a>
        <a href="#" onclick="navigate('leaderboard')" class="hover:text-yellow-400" data-i18n="leaderboard">Leaderboard</a>
      </div>

      <!-- RIGHT -->
      <div class="flex items-center gap-2">
        <select id="networkSwitcher" onchange="switchNetwork(this.value)"
          class="px-2 py-1 rounded bg-gray-700 text-yellow-400 text-sm">
          <option value="testnet">Testnet</option>
          <option value="mainnet">Mainnet</option>
        </select>

        <select id="langSwitcher" onchange="switchLang(this.value)"
          class="px-2 py-1 rounded bg-gray-700 text-yellow-400 text-sm">
          <option value="id">ID</option>
          <option value="en">EN</option>
        </select>

        <!-- Connect Wallet -->
        <button id="connectBtn" onclick="connectWallet()"
          class="px-4 py-2 bg-yellow-500 text-black rounded-lg font-bold hover:bg-yellow-400">
          Connect Wallet
        </button>
      </div>
    </div>

    <!-- MOBILE MENU -->
    <div id="mobileMenu" class="md:hidden hidden border-t border-gray-700 bg-gray-800 px-4 py-3 space-y-2">
      <a href="#" onclick="navigate('home'); toggleMenu(false)" class="block hover:text-yellow-400">Home</a>
      <a href="#" onclick="navigate('wallet'); toggleMenu(false)" class="block hover:text-yellow-400">Wallet</a>
      <a href="#" onclick="navigate('staking'); toggleMenu(false)" class="block hover:text-yellow-400">Staking</a>
      <a href="#" onclick="navigate('about'); toggleMenu(false)" class="block hover:text-yellow-400">About</a>
      <a href="#" onclick="navigate('contact'); toggleMenu(false)" class="block hover:text-yellow-400">Contact</a>
      <a href="#" onclick="navigate('faq'); toggleMenu(false)" class="block hover:text-yellow-400">FAQ</a>
      <a href="#" onclick="navigate('leaderboard'); toggleMenu(false)" class="block hover:text-yellow-400">Leaderboard</a>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="flex-grow px-4 pt-24 pb-10">
    <!-- HOME -->
    <section id="home" class="page-section active text-center">
      <img src="img/logo.png" alt="KenariCoin Logo" class="w-32 h-32 mx-auto rounded-full shadow-lg border border-yellow-400 glow-hover">
      <h1 class="text-3xl font-bold mt-4 text-yellow-400" data-i18n="welcome">Selamat Datang di KenariCoin</h1>

      <div class="mt-6 max-w-xl mx-auto bg-gray-800 shadow rounded-xl p-4 text-gray-300 glow-hover">
        <h3 class="font-bold mb-2" data-i18n="contract">📜 Alamat Kontrak</h3>
        <div class="flex items-center justify-between gap-3">
          <span id="contractAddr" class="text-sm break-all"></span>
          <button onclick="copyContract()" class="px-3 py-1 bg-yellow-500 text-black rounded-lg text-sm hover:bg-yellow-400 glow-hover">Copy</button>
        </div>
      </div>

      <!-- highlight -->
      <div class="mt-8 max-w-xl mx-auto bg-yellow-500 text-black p-4 rounded-xl shadow text-center font-semibold glow-hover">
        🚀 Staking Rewards & Airdrop Coming Soon!
      </div>

      <!-- CTA -->
      <div class="mt-6 flex justify-center gap-4">
        <a href="https://pancakeswap.finance/swap?outputCurrency=0x1390f63AF92448c46368443496a2bfc1469558de&chain=bsc"
           target="_blank"
           class="px-6 py-3 bg-green-500 hover:bg-green-400 text-white rounded-xl font-bold shadow-lg transform hover:scale-105 transition">
          🛒 Buy KN
        </a>
        <a href="https://x.com/itsmeaukwa36342?t=ytLOQr64DID9yRRMCuhy1g&s=09"
           target="_blank"
           class="px-6 py-3 bg-blue-500 hover:bg-blue-400 text-white rounded-xl font-bold shadow-lg transform hover:scale-105 transition">
          🐦 Twitter
        </a>
      </div>

      <!-- Features -->
      <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
        <div class="bg-gray-800 p-6 rounded-xl shadow text-center glow-hover">
          <div class="text-3xl mb-2">⚡</div>
          <h3 class="font-bold text-yellow-400">Cepat & Murah</h3>
          <p class="text-gray-300 mt-2 text-sm">Transaksi kilat dengan biaya sangat rendah di jaringan BNB Smart Chain.</p>
        </div>
        <div class="bg-gray-800 p-6 rounded-xl shadow text-center glow-hover">
          <div class="text-3xl mb-2">🔒</div>
          <h3 class="font-bold text-yellow-400">Aman & Transparan</h3>
          <p class="text-gray-300 mt-2 text-sm">Smart contract diaudit dan berjalan transparan di blockchain publik.</p>
        </div>
        <div class="bg-gray-800 p-6 rounded-xl shadow text-center glow-hover">
          <div class="text-3xl mb-2">🌍</div>
          <h3 class="font-bold text-yellow-400">Komunitas Global</h3>
          <p class="text-gray-300 mt-2 text-sm">Komunitas aktif yang siap mendorong adopsi KenariCoin.</p>
        </div>
        <div class="bg-gray-800 p-6 rounded-xl shadow text-center glow-hover">
          <div class="text-3xl mb-2">💰</div>
          <h3 class="font-bold text-yellow-400">Staking Reward</h3>
          <p class="text-gray-300 mt-2 text-sm">Holder KN bisa dapat imbal hasil melalui staking.</p>
        </div>
      </div>

      <!-- Tokenomics -->
      <div class="mt-12 max-w-3xl mx-auto bg-gray-800 p-6 rounded-xl shadow glow-hover">
        <h3 class="text-xl font-bold mb-4 text-yellow-400">📊 Tokenomics</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center text-gray-300">
          <div><span class="font-bold text-yellow-400">Symbol</span><br>KN</div>
          <div><span class="font-bold text-yellow-400">Decimals</span><br>6</div>
          <div><span class="font-bold text-yellow-400">Total Supply</span><br>500 Triliun</div>
          <div><span class="font-bold text-yellow-400">Network</span><br>BSC (BEP-20)</div>
        </div>
      </div>

      <!-- Roadmap -->
      <div class="mt-12 max-w-2xl mx-auto text-left">
        <h3 class="text-xl font-bold mb-4 text-yellow-400">🛣️ Roadmap</h3>
        <ul class="space-y-2 text-gray-300">
          <li>✅ Testnet Launch</li>
          <li>🚀 Mainnet Deployment</li>
          <li>📈 Listing di DEX</li>
          <li>🌐 Ekspansi Ekosistem</li>
        </ul>
      </div>
    </section>

    <!-- WALLET -->
    <section id="wallet" class="page-section max-w-md mx-auto text-center">
      <h2 class="text-2xl font-bold mb-4 text-yellow-400" data-i18n="wallet_balance">Wallet Balance</h2>
      <div class="bg-gray-800 rounded-xl shadow p-6 text-left glow-hover">
        <p>BNB: <span id="bnbBalance">0 BNB</span></p>
        <p>KN: <span id="tokenBalance">0 KN</span></p>
      </div>
    </section>

    <!-- STAKING -->
    <section id="staking" class="page-section max-w-md mx-auto text-center">
      <h2 class="text-2xl font-bold mb-4 text-yellow-400" data-i18n="staking_title">Staking KN</h2>
      <div id="stakingContent"></div>
    </section>

    <!-- ABOUT -->
    <section id="about" class="page-section max-w-2xl mx-auto text-center">
      <h2 class="text-2xl font-bold mb-4 text-yellow-400" data-i18n="about_title">Tentang KenariCoin</h2>
      <p class="text-gray-300 leading-relaxed" data-i18n="about_desc">
        KenariCoin (KN) adalah aset digital berbasis BEP-20 yang berjalan di jaringan BNB Smart Chain.
      </p>
    </section>

    <!-- CONTACT -->
    <section id="contact" class="page-section max-w-2xl mx-auto text-center">
      <h2 class="text-2xl font-bold mb-4 text-yellow-400">Contact</h2>
      <p>📧 Email: <a href="mailto:kenaricoinkn@gmail.com" class="text-yellow-400 font-semibold hover:underline">kenaricoinkn@gmail.com</a></p>
      <p>📱 Telegram: <a href="https://t.me/KenariCoinKnc" target="_blank" class="text-yellow-400 font-semibold hover:underline">Join Telegram</a></p>
    </section>

    <!-- FAQ -->
    <section id="faq" class="page-section max-w-2xl mx-auto text-center">
      <h2 class="text-2xl font-bold mb-4 text-yellow-400" data-i18n="faq_title">FAQ</h2>
      <div class="space-y-4 text-gray-300 text-left">
        <div class="bg-gray-800 p-4 shadow rounded-xl glow-hover">
          <h3 class="font-semibold" data-i18n="faq_q1">❓ Apa itu KenariCoin?</h3>
          <p data-i18n="faq_a1">
            KenariCoin (KN) adalah token BEP-20 di jaringan BNB Smart Chain untuk akses DeFi yang mudah & transparan.
          </p>
        </div>
        <div class="bg-gray-800 p-4 shadow rounded-xl glow-hover">
          <h3 class="font-semibold" data-i18n="faq_q2">❓ Apa keunggulan KenariCoin?</h3>
          <p data-i18n="faq_a2">
            🔹 Transaksi cepat & biaya rendah <br>
            🔹 Staking & yield farming <br>
            🔹 Komunitas aktif <br>
            🔹 Potensi pertumbuhan jangka panjang
          </p>
        </div>
        <div class="bg-gray-800 p-4 shadow rounded-xl glow-hover">
          <h3 class="font-semibold" data-i18n="faq_q3">❓ Bagaimana cara mendapatkan KenariCoin?</h3>
          <p data-i18n="faq_a3">
            Faucet (testnet), airdrop komunitas, dan listing DEX ke depannya.
          </p>
        </div>
        <div class="bg-gray-800 p-4 shadow rounded-xl glow-hover">
          <h3 class="font-semibold" data-i18n="faq_q4">❓ Apakah ada fitur staking?</h3>
          <p data-i18n="faq_a4">
            Ya. Staking tersedia di testnet dan segera di mainnet.
          </p>
        </div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="leaderboard" class="page-section max-w-4xl mx-auto text-center">
      <h2 class="text-2xl font-bold mb-6 text-yellow-400">🏆 Staking Leaderboard</h2>
      <div class="overflow-x-auto">
        <table class="w-full border border-gray-700 rounded-xl overflow-hidden">
          <thead class="bg-gray-800 text-yellow-400">
            <tr>
              <th class="px-4 py-2 text-left">Rank</th>
              <th class="px-4 py-2 text-left">Address</th>
              <th class="px-4 py-2 text-right">Staked KN</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody" class="bg-gray-900 divide-y divide-gray-700"></tbody>
        </table>
      </div>
      <div class="mt-6">
        <button onclick="viewAllLeaderboard()" class="px-6 py-3 bg-yellow-500 text-black rounded-xl font-bold shadow hover:bg-yellow-400 transform hover:scale-105 transition">
          🔍 View All Stakers
        </button>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="bg-gray-800 border-t border-gray-700 py-4">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between text-gray-400 text-sm">
      <p>© 2025 KenariCoin. All rights reserved.</p>
      <div class="flex space-x-4 mt-2 md:mt-0">
        <a href="#" onclick="navigate('home')" class="hover:text-yellow-400">Home</a>
        <a href="#" onclick="navigate('wallet')" class="hover:text-yellow-400">Wallet</a>
        <a href="#" onclick="navigate('faq')" class="hover:text-yellow-400">FAQ</a>
      </div>
    </div>
  </footer>

<script>
/* ----------------------------
   NAVIGATION & UI HELPERS
---------------------------- */
function showPage(id){
  document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(id);
  if(el) el.classList.add('active');
}
function navigate(id){
  showPage(id);
  toggleMenu(false);
  if(id) history.replaceState(null,'','#'+id);
}
function toggleMenu(force){
  const m=document.getElementById('mobileMenu'); if(!m) return;
  if(typeof force==='boolean'){ m.classList.toggle('hidden', !force); }
  else m.classList.toggle('hidden');
}
function copyContract(){
  const a=document.getElementById('contractAddr')?.innerText;
  if(a){ navigator.clipboard.writeText(a); alert('✅ Disalin: '+a); }
}
function isMobile(){ return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent); }
function setConnectedState(connected){
  const btn=document.getElementById('connectBtn');
  if(!btn) return;
  if(connected){
    btn.classList.remove('bg-yellow-500','hover:bg-yellow-400','text-black');
    btn.classList.add('bg-red-600','hover:bg-red-500','text-white');
  }else{
    btn.classList.add('bg-yellow-500','hover:bg-yellow-400','text-black');
    btn.classList.remove('bg-red-600','hover:bg-red-500','text-white');
    btn.innerText='Connect Wallet';
  }
}

/* ----------------------------
   GLOBAL STATE & ABIs
---------------------------- */
let provider=null, signer=null, userAddress=null;
let KN="", STAKING_CONTRACT="", FAUCET_CONTRACT="", BSC_CHAIN_ID="";

const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function approve(address spender, uint256 amount) returns (bool)"
];
const STAKING_ABI = [
  "function stake(uint256 amount) external",
  "function withdraw(uint256 amount) external",
  "function claimReward() external",
  "function pendingReward(address user) view returns (uint256)",
  "function getStaked(address user) view returns (uint256)"
];
const FAUCET_ABI = ["function faucet() external"];

/* ----------------------------
   WEB3MODAL (UNIVERSAL POPUP)
---------------------------- */
const modal = new window.Web3Modal.default({
  projectId: "b83eac64f87cfacdeb60ef81ba5c6a1d", // 🔑 ganti dengan Project ID dari cloud.walletconnect.com
  chains: [
    { chainId: 97, name: "BSC Testnet", currency: "BNB", rpcUrl: "https://data-seed-prebsc-1-s1.binance.org:8545/" },
    { chainId: 56, name: "BNB Smart Chain", currency: "BNB", rpcUrl: "https://bsc-dataseed.binance.org/" }
  ],
  metadata: {
    name: "KenariCoin Dashboard",
    description: "Stake and manage KenariCoin easily",
    url: window.location.origin,
    icons: ["img/logo.png"]
  }
});

/* ----------------------------
   CONNECT FLOW
---------------------------- */
async function connectWallet(){
  try {
    const session = await modal.connect();                 // buka pop-up pilihan wallet
    provider     = new ethers.providers.Web3Provider(session);
    signer       = provider.getSigner();
    userAddress  = await signer.getAddress();

    // tampilkan short address di tombol
    const shortAddr = userAddress.substring(0,6)+"..."+userAddress.slice(-4);
    const btn = document.getElementById('connectBtn');
    if(btn){ btn.innerText = shortAddr; }
    setConnectedState(true);

    // pastikan chain sesuai pilihan UI
    await ensureWalletOnSelectedChain();

    // update UI data
    await updateBalances();
    if(BSC_CHAIN_ID === '0x61'){ await updateStaked(); await updateReward(); }
  } catch(err){
    console.error("Connect Wallet error:", err);
    alert("❌ Gagal connect: " + (err?.message || err));
    setConnectedState(false);
  }
}

/* ----------------------------
   NETWORK SWITCHER (UI → state)
---------------------------- */
function switchNetwork(mode){
  if(mode === 'testnet'){
    KN = "0xaD3Ce803305615C73CfEB2239254501738FD91b8";
    STAKING_CONTRACT = "0xD9f344e8082c374A10e833fd4AA9fA2209eaE1a5";
    FAUCET_CONTRACT  = "0x261b3d34833C1Fc3253A036E8271528439f3310d";
    BSC_CHAIN_ID = "0x61";
    loadStakingForm();
  } else {
    KN = "0x1390f63AF92448c46368443496a2bfc1469558de";
    STAKING_CONTRACT = "";
    FAUCET_CONTRACT  = "";
    BSC_CHAIN_ID = "0x38";
    loadStakingUnavailable();
  }
  const el=document.getElementById('contractAddr'); if(el) el.innerText = KN || '(No token address)';

  // bila sudah connect → sinkronkan chain & refresh data
  if(userAddress && provider){
    ensureWalletOnSelectedChain().finally(()=>{
      updateBalances();
      if(BSC_CHAIN_ID === '0x61'){ updateStaked(); updateReward(); }
      else {
        document.getElementById('totalStaked') && (document.getElementById('totalStaked').innerText='0 KN');
        document.getElementById('pendingReward') && (document.getElementById('pendingReward').innerText='0 KN');
      }
    });
  }
}

/* ----------------------------
   ENSURE WALLET ON SELECTED CHAIN
---------------------------- */
async function ensureWalletOnSelectedChain(){
  // hanya bisa switch otomatis ke extension-injected (window.ethereum)
  if(!window.ethereum) return;
  try{
    const chainId = await window.ethereum.request({ method:'eth_chainId' });
    if(chainId === BSC_CHAIN_ID) return;

    await window.ethereum.request({
      method:'wallet_switchEthereumChain',
      params:[{ chainId: BSC_CHAIN_ID }]
    });
  }catch(err){
    // kalau chain belum ada di wallet → add chain
    if(err && err.code === 4902){
      try{
        if(BSC_CHAIN_ID === '0x61'){
          await window.ethereum.request({
            method:'wallet_addEthereumChain',
            params:[{
              chainId:'0x61',
              chainName:'BNB Smart Chain Testnet',
              nativeCurrency:{ name:'tBNB', symbol:'tBNB', decimals:18 },
              rpcUrls:['https://data-seed-prebsc-1-s1.binance.org:8545/'],
              blockExplorerUrls:['https://testnet.bscscan.com']
            }]
          });
        }else{
          await window.ethereum.request({
            method:'wallet_addEthereumChain',
            params:[{
              chainId:'0x38',
              chainName:'BNB Smart Chain Mainnet',
              nativeCurrency:{ name:'BNB', symbol:'BNB', decimals:18 },
              rpcUrls:['https://bsc-dataseed.binance.org/'],
              blockExplorerUrls:['https://bscscan.com']
            }]
          });
        }
      }catch(addErr){ console.warn('Add chain failed', addErr); }
    }else{
      console.warn('Switch chain failed', err);
    }
  }
}

/* ----------------------------
   BALANCES & STAKING
---------------------------- */
function formatToken(amountBigNumber, decimals){
  try { return Number(ethers.utils.formatUnits(amountBigNumber, decimals)); }
  catch(e){ return 0; }
}

async function updateBalances(){
  if(!provider || !userAddress) return;
  try{
    const bnbBN = await provider.getBalance(userAddress);
    const bnbStr = Number(ethers.utils.formatUnits(bnbBN,18)).toFixed(4);
    document.getElementById('bnbBalance').innerText = bnbStr + ' BNB';

    if(!KN) { document.getElementById('tokenBalance').innerText='0 KN'; return; }
    const token = new ethers.Contract(KN, ERC20_ABI, provider);
    const raw = await token.balanceOf(userAddress);
    const decimals = await token.decimals();
    const formatted = ethers.utils.formatUnits(raw, decimals);
    const display = Number(formatted).toFixed(Math.min(Math.max(decimals,2),6));
    document.getElementById('tokenBalance').innerText = display + ' KN';
  }catch(err){ console.error('updateBalances error', err); }
}

async function doStake(){
  if(!signer) return alert('Hubungkan wallet dulu!');
  if(!STAKING_CONTRACT) return alert('Staking belum tersedia pada jaringan ini.');
  const rawAmount = document.getElementById('stakeAmount')?.value;
  const amount = parseFloat(rawAmount);
  if(isNaN(amount) || amount<=0) return alert('Masukkan jumlah KN valid.');
  try{
    const token = new ethers.Contract(KN, ERC20_ABI, signer);
    const decimals = await token.decimals();
    const parsed = ethers.utils.parseUnits(amount.toString(), decimals);

    const approveTx = await token.approve(STAKING_CONTRACT, parsed);
    await approveTx.wait();

    const staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
    const tx = await staking.stake(parsed);
    await tx.wait();

    alert('✅ Berhasil staking ' + amount + ' KN');
    document.getElementById('stakeAmount').value = '';
    await updateBalances(); await updateStaked(); await updateReward();
  }catch(err){
    console.error('doStake error', err);
    alert('❌ Gagal staking: ' + (err?.data?.message || err.message || err));
  }
}

async function doWithdraw(){
  if(!signer) return alert('Hubungkan wallet dulu!');
  if(!STAKING_CONTRACT) return alert('Staking belum tersedia pada jaringan ini.');
  const amount = prompt('Masukkan jumlah KN untuk withdraw:');
  if(!amount) return;
  const num = parseFloat(amount);
  if(isNaN(num) || num<=0) return alert('Jumlah tidak valid.');
  try{
    const token = new ethers.Contract(KN, ERC20_ABI, provider);
    const decimals = await token.decimals();
    const parsed = ethers.utils.parseUnits(num.toString(), decimals);
    const staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
    const tx = await staking.withdraw(parsed);
    await tx.wait();
    alert('✅ Berhasil withdraw ' + num + ' KN');
    await updateBalances(); await updateStaked(); await updateReward();
  }catch(err){
    console.error('doWithdraw error', err);
    alert('❌ Gagal withdraw: ' + (err?.data?.message || err.message || err));
  }
}

async function claimReward(){
  if(!signer) return alert('Hubungkan wallet dulu!');
  if(!STAKING_CONTRACT) return alert('Staking belum tersedia pada jaringan ini.');
  try{
    const staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
    const tx = await staking.claimReward();
    await tx.wait();
    alert('🎉 Reward berhasil diclaim!');
    await updateBalances(); await updateStaked(); await updateReward();
  }catch(err){
    console.error('claimReward error', err);
    alert('❌ Claim gagal: ' + (err?.data?.message || err.message || err));
  }
}

async function updateStaked(){
  if(!provider || !userAddress) return;
  if(!STAKING_CONTRACT){ document.getElementById('totalStaked') && (document.getElementById('totalStaked').innerText='0 KN'); return; }
  try{
    const staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, provider);
    const token = new ethers.Contract(KN, ERC20_ABI, provider);
    const decimals = await token.decimals();
    const bal = await staking.getStaked(userAddress);
    const formatted = ethers.utils.formatUnits(bal, decimals);
    document.getElementById('totalStaked').innerText = Number(formatted).toFixed(Math.min(Math.max(decimals,2),6)) + ' KN';
  }catch(err){ console.error('updateStaked error', err); }
}

async function updateReward(){
  if(!provider || !userAddress) return;
  if(!STAKING_CONTRACT){ document.getElementById('pendingReward') && (document.getElementById('pendingReward').innerText='0 KN'); return; }
  try{
    const staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, provider);
    const token = new ethers.Contract(KN, ERC20_ABI, provider);
    const decimals = await token.decimals();
    const reward = await staking.pendingReward(userAddress);
    const formatted = ethers.utils.formatUnits(reward, decimals);
    document.getElementById('pendingReward').innerText = Number(formatted).toFixed(Math.min(Math.max(decimals,2),6)) + ' KN';
  }catch(err){ console.error('updateReward error', err); }
}

/* ----------------------------
   STAKING UI BUILDER
---------------------------- */
function loadStakingForm(){
  document.getElementById('stakingContent').innerHTML = `
    <div class="bg-gray-800 rounded-xl shadow p-6 glow-hover">
      <label class="block mb-2 font-semibold" data-i18n="staking_input_label">Jumlah KN untuk Staking</label>
      <input type="number" id="stakeAmount" placeholder="0.0" class="w-full p-3 border border-gray-600 rounded-xl mb-4 bg-gray-900 text-white" />
      <button id="stakeBtn" onclick="doStake()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-500 glow-hover mb-2" data-i18n="staking_btn_stake">Stake</button>
      <button id="withdrawBtn" onclick="doWithdraw()" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-500 glow-hover" data-i18n="staking_btn_withdraw">Withdraw</button>
      <p class="mt-4"><span data-i18n="staking_total">Total Staked</span>: <span id="totalStaked">0 KN</span></p>
      <p class="mt-2"><span data-i18n="staking_reward">Pending Reward</span>: <span id="pendingReward">0 KN</span></p>
      <button id="claimRewardBtn" onclick="claimReward()" class="w-full mt-3 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-500 glow-hover" data-i18n="staking_btn_claim">Claim Reward</button>
    </div>
    <div class="bg-gray-800 rounded-xl shadow p-6 mt-6 glow-hover">
      <h3 class="text-lg font-bold mb-3 text-yellow-400" data-i18n="faucet_title">Faucet</h3>
      <p class="text-gray-300 mb-3" data-i18n="faucet_desc">Dapatkan token KN gratis untuk uji coba.</p>
      <button id="faucetBtn" onclick="claimFaucet()" class="w-full py-3 bg-yellow-500 text-black font-bold rounded-xl hover:bg-yellow-400 glow-hover" data-i18n="faucet_btn">Claim Faucet</button>
    </div>
  `;
}
function loadStakingUnavailable(){
  document.getElementById('stakingContent').innerHTML = `
    <div class="bg-gray-800 rounded-xl shadow p-6 glow-hover">
      <h3 class="text-xl font-bold mb-3 text-yellow-400">🚧 Staking Belum Tersedia di Mainnet</h3>
      <p class="text-gray-300 leading-relaxed">Silakan gunakan <strong class="text-yellow-400">Testnet</strong> untuk mencoba staking dan faucet.</p>
    </div>
  `;
}

/* ----------------------------
   FAUCET (Testnet Only)
---------------------------- */
async function claimFaucet(){
  const btn=document.getElementById('faucetBtn');
  if(!signer){ alert('Hubungkan wallet dulu!'); return; }
  if(!FAUCET_CONTRACT){ alert('Faucet belum tersedia pada jaringan ini.'); return; }
  try{
    if(btn){ btn.disabled=true; btn.innerText='Claiming...'; }
    const faucet = new ethers.Contract(FAUCET_CONTRACT, FAUCET_ABI, signer);
    const tx = await faucet.faucet();
    await tx.wait();
    alert('🎉 Faucet berhasil! Token KN masuk ke wallet Anda.');
    await updateBalances();
  }catch(err){
    console.error('claimFaucet error', err);
    let msg = err?.data?.message || err?.error?.message || err?.reason || err?.message || 'Gagal claim faucet';
    if(typeof msg !== 'string') msg = JSON.stringify(msg);
    if(msg.toLowerCase().includes('execution reverted')) msg = msg.split('execution reverted:').pop().trim();
    alert('❌ ' + msg);
  }finally{
    if(btn){ btn.disabled=false; btn.innerText='Claim Faucet'; }
  }
}

/* ----------------------------
   WALLET EVENTS (if browser wallet)
---------------------------- */
if(window.ethereum){
  window.ethereum.on('accountsChanged', async (accs)=>{
    if(!accs || accs.length===0){
      userAddress=null; provider=null; signer=null;
      setConnectedState(false);
      document.getElementById('bnbBalance').innerText='0 BNB';
      document.getElementById('tokenBalance').innerText='0 KN';
      document.getElementById('totalStaked') && (document.getElementById('totalStaked').innerText='0 KN');
      document.getElementById('pendingReward') && (document.getElementById('pendingReward').innerText='0 KN');
      return;
    }
    userAddress=accs[0];
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer   = provider.getSigner();
    setConnectedState(true);
    await updateBalances(); if(BSC_CHAIN_ID==='0x61'){ await updateStaked(); await updateReward(); }
  });
  window.ethereum.on('chainChanged', ()=>{ setTimeout(()=>location.reload(), 200); });
}

/* ----------------------------
   MULTI-LANGUAGE
---------------------------- */
const translations = {
  id: {
    home:"Beranda", wallet:"Dompet", staking:"Staking", about:"Tentang", contact:"Kontak", faq:"FAQ", leaderboard:"Leaderboard",
    welcome:"Selamat Datang di KenariCoin",
    contract:"📜 Alamat Kontrak",
    wallet_balance:"Saldo Wallet",
    about_title:"Tentang KenariCoin",
    about_desc:
      "KenariCoin (KN) adalah aset digital berbasis BEP-20 di BNB Smart Chain.\n\n" +
      "🔹 Testnet → Staking & faucet tersedia untuk uji coba.\n" +
      "🔹 Mainnet → Trading di DEX, staking menyusul.\n",
    faq_title:"FAQ",
    faq_q1:"❓ Apa itu KenariCoin?",
    faq_a1:"Token BEP-20 untuk akses DeFi yang mudah & transparan.",
    faq_q2:"❓ Apa keunggulan KenariCoin?",
    faq_a2:"Transaksi cepat, biaya rendah, staking, komunitas aktif.",
    faq_q3:"❓ Bagaimana cara mendapatkan KenariCoin?",
    faq_a3:"Faucet (testnet), airdrop, dan listing DEX.",
    faq_q4:"❓ Apakah ada fitur staking?",
    faq_a4:"Ya. Tersedia di testnet, segera di mainnet.",
    staking_title:"Staking KN",
    staking_input_label:"Jumlah KN untuk Staking",
    staking_btn_stake:"Stake",
    staking_btn_withdraw:"Withdraw",
    staking_total:"Total Staked",
    staking_reward:"Reward Tertunda",
    staking_btn_claim:"Klaim Reward",
    faucet_title:"Faucet",
    faucet_desc:"Dapatkan token KN gratis untuk uji coba.",
    faucet_btn:"Klaim Faucet",
  },
  en: {
    home:"Home", wallet:"Wallet", staking:"Staking", about:"About", contact:"Contact", faq:"FAQ", leaderboard:"Leaderboard",
    welcome:"Welcome to KenariCoin",
    contract:"📜 Contract Address",
    wallet_balance:"Wallet Balance",
    about_title:"About KenariCoin",
    about_desc:
      "KenariCoin (KN) is a BEP-20 asset on BNB Smart Chain.\n\n" +
      "🔹 Testnet → Staking & faucet available for testing.\n" +
      "🔹 Mainnet → Tradable on DEX, staking coming soon.\n",
    faq_title:"FAQ",
    faq_q1:"❓ What is KenariCoin?",
    faq_a1:"A BEP-20 token for easy & transparent DeFi access.",
    faq_q2:"❓ What are the advantages?",
    faq_a2:"Fast, low fees, staking, active community.",
    faq_q3:"❓ How to get KenariCoin?",
    faq_a3:"Faucet (testnet), airdrops, and DEX listings.",
    faq_q4:"❓ Is staking available?",
    faq_a4:"Yes on testnet, mainnet soon.",
    staking_title:"Stake KN",
    staking_input_label:"Amount of KN to Stake",
    staking_btn_stake:"Stake",
    staking_btn_withdraw:"Withdraw",
    staking_total:"Total Staked",
    staking_reward:"Pending Reward",
    staking_btn_claim:"Claim Reward",
    faucet_title:"Faucet",
    faucet_desc:"Get free KN tokens for testing.",
    faucet_btn:"Claim Faucet",
  }
};
function switchLang(lang){
  localStorage.setItem("lang", lang);
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key=el.getAttribute("data-i18n");
    if(translations[lang] && translations[lang][key]){
      if(key==="about_desc"){ el.innerHTML = translations[lang][key]; }
      else { el.textContent = translations[lang][key]; }
    }
  });
}

/* ----------------------------
   LEADERBOARD (Mock)
---------------------------- */
let leaderboardData = [
  {address:"0xA123...111", staked:120000},
  {address:"0xB456...222", staked:95000},
  {address:"0xC789...333", staked:85000},
  {address:"0xD111...444", staked:74000},
  {address:"0xE222...555", staked:68000},
  {address:"0xF333...666", staked:53000},
  {address:"0xG444...777", staked:49000},
  {address:"0xH555...888", staked:42000},
  {address:"0xI666...999", staked:39000},
  {address:"0xJ777...AAA", staked:35000},
  {address:"0xK888...BBB", staked:30000},
];
function loadLeaderboard(topOnly=true){
  const tbody=document.getElementById("leaderboardBody");
  if(!tbody) return;
  tbody.innerHTML="";
  let data=[...leaderboardData];
  data.sort((a,b)=>b.staked-a.staked);
  if(topOnly) data=data.slice(0,10);
  data.forEach((row,i)=>{
    const tr=document.createElement("tr");
    tr.className="hover:bg-gray-800 transition";
    tr.innerHTML = `
      <td class="px-4 py-2 font-bold ${i<3?'text-yellow-400':''}">#${i+1}</td>
      <td class="px-4 py-2">${row.address}</td>
      <td class="px-4 py-2 text-right">${row.staked.toLocaleString()} KN</td>
    `;
    tbody.appendChild(tr);
  });
}
function viewAllLeaderboard(){ loadLeaderboard(false); }

/* ----------------------------
   INIT + SW REGISTER
---------------------------- */
window.addEventListener('DOMContentLoaded', ()=>{
  // default language
  const savedLang = localStorage.getItem("lang") || "id";
  document.getElementById("langSwitcher").value = savedLang;
  switchLang(savedLang);

  // default network
  document.getElementById('networkSwitcher').value='testnet';
  switchNetwork('testnet');

  // page by hash
  const hash = location.hash?.replace('#','') || 'home';
  showPage(hash);

  // contract label
  document.getElementById('contractAddr').innerText = KN || '';

  // leaderboard
  loadLeaderboard(true);
});

// PWA Service Worker (opsional)
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg=>console.log('✅ ServiceWorker registered:', reg))
      .catch(err=>console.log('❌ ServiceWorker failed:', err));
  });
}
</script>
</body>
</html>
