<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KenariCoin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="img/logo.png" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    .page-section { opacity:0; transform:translateY(10px); transition:opacity .35s ease,transform .35s ease; display:none; }
    .page-section.active { display:block; opacity:1; transform:translateY(0); }
    .glow-hover:hover { box-shadow:0 0 12px rgba(250,204,21,.7); transition:box-shadow .25s ease; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

  <!-- NAVBAR -->
  <nav class="bg-gray-800 shadow fixed w-full z-30 top-0 border-b border-gray-700">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-16">
      <div class="flex items-center gap-3">
        <button id="menuBtn" class="md:hidden p-2 rounded hover:bg-gray-700" onclick="toggleMenu()" aria-label="Open menu">‚ò∞</button>
        <img src="img/logo.png" alt="Logo" class="w-10 h-10 rounded-full">
        <span class="font-bold text-lg text-yellow-400 select-none">KenariCoin</span>
      </div>

      <div id="navLinks" class="hidden md:flex space-x-6">
        <a href="#" onclick="navigate('home')" class="hover:text-yellow-400">Home</a>
        <a href="#" onclick="navigate('wallet')" class="hover:text-yellow-400">Wallet</a>
        <a href="#" onclick="navigate('staking')" class="hover:text-yellow-400">Staking</a>
        <a href="#" onclick="navigate('about')" class="hover:text-yellow-400">About</a>
        <a href="#" onclick="navigate('contact')" class="hover:text-yellow-400">Contact</a>
        <a href="#" onclick="navigate('faq')" class="hover:text-yellow-400">FAQ</a>
      </div>

      <div class="flex items-center gap-2">
        <select id="networkSwitcher" onchange="switchNetwork(this.value)"
          class="px-2 py-1 rounded bg-gray-700 text-yellow-400 text-sm">
          <option value="testnet">Testnet</option>
          <option value="mainnet">Mainnet</option>
        </select>

        <button id="connectBtn" onclick="openModal()"
          class="px-3 py-1.5 bg-yellow-500 text-black rounded-lg font-semibold hover:bg-yellow-400 shadow glow-hover text-sm w-auto">
          Connect
        </button>
      </div>
    </div>

    <div id="mobileMenu" class="md:hidden hidden border-t border-gray-700 bg-gray-800 px-4 py-3 space-y-2">
      <a href="#" onclick="navigate('home'); toggleMenu(false)" class="block hover:text-yellow-400">Home</a>
      <a href="#" onclick="navigate('wallet'); toggleMenu(false)" class="block hover:text-yellow-400">Wallet</a>
      <a href="#" onclick="navigate('staking'); toggleMenu(false)" class="block hover:text-yellow-400">Staking</a>
      <a href="#" onclick="navigate('about'); toggleMenu(false)" class="block hover:text-yellow-400">About</a>
      <a href="#" onclick="navigate('contact'); toggleMenu(false)" class="block hover:text-yellow-400">Contact</a>
      <a href="#" onclick="navigate('faq'); toggleMenu(false)" class="block hover:text-yellow-400">FAQ</a>
    </div>
  </nav>

  <!-- PAGES -->
  <main class="flex-grow px-4 pt-24 pb-10">
    <!-- Home -->
    <section id="home" class="page-section text-center active">
      <img src="img/logo.png" alt="KenariCoin Logo" class="w-32 h-32 rounded-full mx-auto shadow-lg border border-yellow-400 glow-hover">
      <h1 class="text-3xl font-bold mt-4 text-yellow-400">Selamat Datang di KenariCoin</h1>

      <div class="mt-6 max-w-xl mx-auto bg-gray-800 shadow rounded-xl p-4 text-gray-300 glow-hover">
        <h3 class="font-bold mb-2">üìú Contract Address</h3>
        <div class="flex items-center justify-between gap-3">
          <span id="contractAddr" class="text-sm break-all"></span>
          <button onclick="copyContract()" class="px-3 py-1 bg-yellow-500 text-black rounded-lg text-sm hover:bg-yellow-400 glow-hover">Copy</button>
        </div>
      </div>
    </section>

    <!-- Wallet -->
    <section id="wallet" class="page-section max-w-md mx-auto text-center">
      <h2 class="text-2xl font-bold mb-4 text-yellow-400">Wallet Balance</h2>
      <div class="bg-gray-800 rounded-xl shadow p-6 text-left glow-hover">
        <p>BNB: <span id="bnbBalance">0 BNB</span></p>
        <p>KN: <span id="tokenBalance">0 KN</span></p>
      </div>
    </section>

    <!-- Staking -->
    <section id="staking" class="page-section max-w-md mx-auto text-center">
      <h2 class="text-2xl font-bold mb-4 text-yellow-400">Staking KN</h2>
      <div id="stakingContent"></div>
    </section>

    <!-- About -->
    <section id="about" class="page-section max-w-2xl mx-auto text-center">
      <h2 class="text-2xl font-bold mb-4 text-yellow-400">Tentang KenariCoin</h2>
      <p class="text-gray-300 leading-relaxed">
        KenariCoin (KN) adalah token BEP-20 di BNB Smart Chain yang dirancang untuk ekosistem DeFi.
      </p>
    </section>

    <!-- Contact -->
    <section id="contact" class="page-section max-w-2xl mx-auto text-center">
      <h2 class="text-2xl font-bold mb-4 text-yellow-400">Contact</h2>
      <p>üìß Email: <a href="mailto:kenaricoinkn@gmail.com" class="text-yellow-400 font-semibold hover:underline">kenaricoinkn@gmail.com</a></p>
      <p>üì± Telegram: <a href="https://t.me/KenariCoinKnc" target="_blank" class="text-yellow-400 font-semibold hover:underline">Join Telegram</a></p>
    </section>

    <!-- FAQ -->
    <section id="faq" class="page-section max-w-2xl mx-auto text-center">
      <h2 class="text-2xl font-bold mb-4 text-yellow-400">FAQ</h2>
      <div class="space-y-4 text-gray-300 text-left">
        <div class="bg-gray-800 p-4 shadow rounded-xl glow-hover"><h3 class="font-semibold">‚ùì Apa itu KenariCoin?</h3><p>Token BEP-20 berbasis BSC untuk ekosistem DeFi.</p></div>
        <div class="bg-gray-800 p-4 shadow rounded-xl glow-hover"><h3 class="font-semibold">‚ùì Bagaimana cara mendapatkan KN?</h3><p>Lewat faucet (testnet), airdrop komunitas, atau listing DEX.</p></div>
        <div class="bg-gray-800 p-4 shadow rounded-xl glow-hover"><h3 class="font-semibold">‚ùì Apakah ada fitur staking?</h3><p>Ya, tersedia di testnet sekarang. Mainnet sedang dipersiapkan.</p></div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="bg-gray-800 border-t border-gray-700 py-4">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between text-gray-400 text-sm">
      <p>¬© 2025 KenariCoin. All rights reserved.</p>
      <div class="flex space-x-4 mt-2 md:mt-0">
        <a href="#" onclick="navigate('home')" class="hover:text-yellow-400">Home</a>
        <a href="#" onclick="navigate('wallet')" class="hover:text-yellow-400">Wallet</a>
        <a href="#" onclick="navigate('faq')" class="hover:text-yellow-400">FAQ</a>
      </div>
    </div>
  </footer>

  <!-- WALLET MODAL -->
  <div id="walletModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 rounded-2xl p-6 w-80 shadow-lg text-gray-100 glow-hover">
      <h2 class="text-lg font-bold mb-4 text-center">Connect Wallet</h2>
      <div class="space-y-3">
        <button onclick="selectWallet('metamask')" class="w-full border border-gray-600 rounded-lg py-2 hover:bg-gray-700 glow-hover">ü¶ä MetaMask</button>
        <button onclick="selectWallet('okx')" class="w-full border border-gray-600 rounded-lg py-2 hover:bg-gray-700 glow-hover">‚ö´ OKX Wallet</button>
      </div>
      <button onclick="closeModal()" class="w-full mt-3 py-2 border border-gray-600 rounded-lg hover:bg-gray-700 glow-hover">Cancel</button>
    </div>
  </div>

<script>
/* ----------------------------
   SCRIPT BLOCKCHAIN & UI
   ---------------------------- */

// ===== Utility UI =====
function showPage(id){ document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active')); const el=document.getElementById(id); if(el) el.classList.add('active'); }
function navigate(id){ showPage(id); closeModal(); toggleMenu(false); if(id) history.replaceState(null,'','#'+id); }
function toggleMenu(force){ const m=document.getElementById('mobileMenu'); if(!m) return; if(typeof force==='boolean'){ m.classList.toggle('hidden', !force); } else m.classList.toggle('hidden'); }
function openModal(){ document.getElementById('walletModal').classList.remove('hidden'); }
function closeModal(){ document.getElementById('walletModal').classList.add('hidden'); }
function copyContract(){ const a=document.getElementById('contractAddr')?.innerText; if(a){ navigator.clipboard.writeText(a); alert('‚úÖ Disalin: '+a); } }

// Toast notification
function showToast(msg, type='info') {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-6 right-6 px-4 py-2 rounded-lg shadow-lg z-50 text-white font-semibold ${
    type === 'success' ? 'bg-green-600' :
    type === 'error' ? 'bg-red-600' :
    type === 'warning' ? 'bg-yellow-500 text-black' : 'bg-gray-700'
  }`;
  toast.innerText = msg;
  document.body.appendChild(toast);
  setTimeout(() => { toast.remove(); }, 3500);
}

// Connect button state
function setConnectedState(connected) {
  const btn = document.getElementById('connectBtn');
  if(!btn) return;
  if(connected) {
    btn.innerText = 'Connected';
    btn.classList.remove('bg-yellow-500','hover:bg-yellow-400','text-black');
    btn.classList.add('bg-red-600','hover:bg-red-500','text-white');
  } else {
    btn.innerText = 'Connect';
    btn.classList.remove('bg-red-600','hover:bg-red-500','text-white');
    btn.classList.add('bg-yellow-500','hover:bg-yellow-400','text-black');
  }
}

// Blockchain / contract variables (akan di-set oleh switchNetwork)
let KN = '', STAKING_CONTRACT = '', FAUCET_CONTRACT = '', BSC_CHAIN_ID = '';
const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function approve(address spender, uint256 amount) returns (bool)"
];
const STAKING_ABI = [
  "function stake(uint256 amount) external",
  "function withdraw(uint256 amount) external",
  "function claimReward() external",
  "function pendingReward(address user) view returns (uint256)",
  "function getStaked(address user) view returns (uint256)"
];
const FAUCET_ABI = ["function faucet() external"];

let provider = null, signer = null, userAddress = null;

// Helper: format units using decimals
function formatToken(amountBigNumber, decimals){
  try { return Number(ethers.utils.formatUnits(amountBigNumber, decimals)); }
  catch(e){ return 0; }
}

// ========== SWITCH NETWORK ==========
function switchNetwork(mode){
  if(mode === 'testnet'){
    KN = "0xaD3Ce803305615C73CfEB2239254501738FD91b8";
    STAKING_CONTRACT = "0xD9f344e8082c374A10e833fd4AA9fA2209eaE1a5";
    FAUCET_CONTRACT = "0x261b3d34833C1Fc3253A036E8271528439f3310d";
    BSC_CHAIN_ID = "0x61"; // BSC Testnet
    loadStakingForm();
    document.getElementById('networkSwitcher').value = 'testnet';
  } else {
    KN = "0x1390f63AF92448c46368443496a2bfc1469558de";
    STAKING_CONTRACT = "";
    FAUCET_CONTRACT = "";
    BSC_CHAIN_ID = "0x38"; // BSC Mainnet
    loadStakingUnavailable();
    document.getElementById('networkSwitcher').value = 'mainnet';
  }

  const el = document.getElementById('contractAddr');
  if(el) el.innerText = KN || '(No token address)';

  if(userAddress && provider){
    ensureWalletOnSelectedChain().finally(()=> {
      updateBalances();
      if(BSC_CHAIN_ID === '0x61'){ updateStaked(); updateReward(); }
      else {
        document.getElementById('totalStaked') && (document.getElementById('totalStaked').innerText = '0 KN');
        document.getElementById('pendingReward') && (document.getElementById('pendingReward').innerText = '0 KN');
      }
    });
  }
}

// ========== STAKING UI ==========
function loadStakingForm(){
  document.getElementById('stakingContent').innerHTML = `
    <div class="bg-gray-800 rounded-xl shadow p-6 glow-hover">
      <label class="block mb-2 font-semibold">Jumlah KN untuk Staking</label>
      <input type="number" id="stakeAmount" placeholder="0.0" class="w-full p-3 border border-gray-600 rounded-xl mb-4 bg-gray-900 text-white" />
      <button onclick="doStake()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-500 glow-hover mb-2">Stake</button>
      <button onclick="doWithdraw()" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-500 glow-hover">Withdraw</button>
      <p class="mt-4">Total Staked: <span id="totalStaked">0 KN</span></p>
      <p class="mt-2">Pending Reward: <span id="pendingReward">0 KN</span></p>
      <button onclick="claimReward()" class="w-full mt-3 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-500 glow-hover">Claim Reward</button>
    </div>
    <div class="bg-gray-800 rounded-xl shadow p-6 mt-6 glow-hover">
      <h3 class="text-lg font-bold mb-3 text-yellow-400">Faucet</h3>
      <p class="text-gray-300 mb-3">Dapatkan token KN gratis untuk uji coba.</p>
      <button id="faucetBtn" onclick="claimFaucet()" class="w-full py-3 bg-yellow-500 text-black font-bold rounded-xl hover:bg-yellow-400 glow-hover">Claim Faucet</button>
    </div>
  `;
}

function loadStakingUnavailable(){
  document.getElementById('stakingContent').innerHTML = `
    <div class="bg-gray-800 rounded-xl shadow p-6 glow-hover">
      <h3 class="text-xl font-bold mb-3 text-yellow-400">üöß Staking Belum Tersedia di Mainnet</h3>
      <p class="text-gray-300 leading-relaxed">Fitur staking pada jaringan <strong class="text-yellow-400">Mainnet</strong> sedang dalam tahap persiapan.
      Silakan gunakan <strong class="text-yellow-400">Testnet</strong> untuk mencoba staking dan faucet.</p>
    </div>
  `;
}
// Attempt to switch user's wallet network to currently selected BSC_CHAIN_ID
async function ensureWalletOnSelectedChain(){
  if(!window.ethereum) return;
  try {
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    if(chainId === BSC_CHAIN_ID) return;
    // try switch
    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params:[{ chainId: BSC_CHAIN_ID }] });
  } catch(err){
    if(err && err.code === 4902){
      try {
        if(BSC_CHAIN_ID === '0x61'){
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: '0x61',
              chainName: 'BNB Smart Chain Testnet',
              nativeCurrency: { name: 'tBNB', symbol: 'tBNB', decimals: 18 },
              rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
              blockExplorerUrls: ['https://testnet.bscscan.com']
            }]
          });
        } else {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: '0x38',
              chainName: 'BNB Smart Chain Mainnet',
              nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
              rpcUrls: ['https://bsc-dataseed.binance.org/'],
              blockExplorerUrls: ['https://bscscan.com']
            }]
          });
        }
      } catch(addErr){
        console.warn('Add chain failed', addErr);
      }
    } else {
      console.warn('Switch chain failed', err);
    }
  }
}
// ========== WALLET CONNECT ==========
async function connectMetaMask(){
  if(!window.ethereum) return alert('MetaMask tidak ditemukan. Install MetaMask terlebih dahulu.');
  try {
    await ensureWalletOnSelectedChain();
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();

    setConnectedState(true);
    await updateBalances();
    if(BSC_CHAIN_ID === '0x61'){ await updateStaked(); await updateReward(); }
    closeModal();
  } catch(err){
    console.error(err);
    alert('Gagal connect: ' + (err?.message || err));
    setConnectedState(false);
  }
}

async function connectOKX(){
  if(!(window.okxwallet && window.okxwallet.request)) return alert('OKX Wallet tidak ditemukan.');
  try {
    await ensureWalletOnSelectedChain();
    provider = new ethers.providers.Web3Provider(window.okxwallet);
    await provider.send('eth_requestAccounts', []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();

    setConnectedState(true);
    await updateBalances();
    if(BSC_CHAIN_ID === '0x61'){ await updateStaked(); await updateReward(); }
    closeModal();
  } catch(err){
    console.error(err);
    alert('Gagal connect: ' + (err?.message || err));
    setConnectedState(false);
  }
}

function selectWallet(which){
  if(which === 'metamask') connectMetaMask();
  else if(which === 'okx') connectOKX();
}

// ========== UPDATE BALANCE ==========
async function updateBalances(){
  if(!provider || !userAddress) return;
  try {
    const bnbBN = await provider.getBalance(userAddress);
    const bnbStr = Number(ethers.utils.formatUnits(bnbBN, 18)).toFixed(4);
    document.getElementById('bnbBalance').innerText = bnbStr + ' BNB';

    if(!KN) { document.getElementById('tokenBalance').innerText = '0 KN'; return; }
    const token = new ethers.Contract(KN, ERC20_ABI, provider);
    const raw = await token.balanceOf(userAddress);
    const decimals = await token.decimals();
    const formatted = ethers.utils.formatUnits(raw, decimals);
    const display = Number(formatted).toFixed(Math.min(Math.max(decimals,2),6));
    document.getElementById('tokenBalance').innerText = display + ' KN';
  } catch(err){
    console.error('updateBalances error', err);
  }
}

// ========== STAKING ACTIONS ==========
async function doStake(){
  if(!signer) return alert('Hubungkan wallet dulu!');
  if(!STAKING_CONTRACT) return alert('Staking belum tersedia pada jaringan ini.');
  const rawAmount = document.getElementById('stakeAmount')?.value;
  const amount = parseFloat(rawAmount);
  if(isNaN(amount) || amount <= 0) return alert('Masukkan jumlah KN valid.');
  try {
    const token = new ethers.Contract(KN, ERC20_ABI, signer);
    const decimals = await token.decimals();
    const parsed = ethers.utils.parseUnits(amount.toString(), decimals);

    const approveTx = await token.approve(STAKING_CONTRACT, parsed);
    await approveTx.wait();

    const staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
    const tx = await staking.stake(parsed);
    await tx.wait();

    showToast('‚úÖ Berhasil staking ' + amount + ' KN', "success");
    document.getElementById('stakeAmount').value = '';
    await updateBalances(); await updateStaked(); await updateReward();
  } catch(err){
    console.error('doStake error', err);
    showToast('‚ùå Gagal staking: ' + (err?.data?.message || err.message || err), "error");
  }
}

async function doWithdraw(){
  if(!signer) return alert('Hubungkan wallet dulu!');
  if(!STAKING_CONTRACT) return alert('Staking belum tersedia pada jaringan ini.');
  const amount = prompt('Masukkan jumlah KN untuk withdraw:');
  if(!amount) return;
  const num = parseFloat(amount);
  if(isNaN(num) || num <= 0) return alert('Jumlah tidak valid.');
  try {
    const token = new ethers.Contract(KN, ERC20_ABI, provider);
    const decimals = await token.decimals();
    const parsed = ethers.utils.parseUnits(num.toString(), decimals);
    const staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
    const tx = await staking.withdraw(parsed);
    await tx.wait();
    showToast('‚úÖ Berhasil withdraw ' + num + ' KN', "success");
    await updateBalances(); await updateStaked(); await updateReward();
  } catch(err){
    console.error('doWithdraw error', err);
    showToast('‚ùå Gagal withdraw: ' + (err?.data?.message || err.message || err), "error");
  }
}

async function claimReward(){
  if(!signer) return alert('Hubungkan wallet dulu!');
  if(!STAKING_CONTRACT) return alert('Staking belum tersedia pada jaringan ini.');
  try {
    const staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
    const tx = await staking.claimReward();
    await tx.wait();
    showToast('üéâ Reward berhasil diclaim!', "success");
    await updateBalances(); await updateStaked(); await updateReward();
  } catch(err){
    console.error('claimReward error', err);
    showToast('‚ùå Claim gagal: ' + (err?.data?.message || err.message || err), "error");
  }
}

async function updateStaked(){
  if(!provider || !userAddress) return;
  if(!STAKING_CONTRACT) { document.getElementById('totalStaked') && (document.getElementById('totalStaked').innerText='0 KN'); return; }
  try {
    const staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, provider);
    const token = new ethers.Contract(KN, ERC20_ABI, provider);
    const decimals = await token.decimals();
    const bal = await staking.getStaked(userAddress);
    const formatted = ethers.utils.formatUnits(bal, decimals);
    document.getElementById('totalStaked').innerText = Number(formatted).toFixed(Math.min(Math.max(decimals,2),6)) + ' KN';
  } catch(err){
    console.error('updateStaked error', err);
  }
}

async function updateReward(){
  if(!provider || !userAddress) return;
  if(!STAKING_CONTRACT) { document.getElementById('pendingReward') && (document.getElementById('pendingReward').innerText='0 KN'); return; }
  try {
    const staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, provider);
    const token = new ethers.Contract(KN, ERC20_ABI, provider);
    const decimals = await token.decimals();
    const reward = await staking.pendingReward(userAddress);
    const formatted = ethers.utils.formatUnits(reward, decimals);
    document.getElementById('pendingReward').innerText = Number(formatted).toFixed(Math.min(Math.max(decimals,2),6)) + ' KN';
  } catch(err){
    console.error('updateReward error', err);
  }
}

async function claimFaucet(){
  const btn = document.getElementById('faucetBtn');
  if(!signer) {
    showToast('Hubungkan wallet dulu!', "warning");
    return;
  }
  if(!FAUCET_CONTRACT) {
    showToast('Faucet belum tersedia pada jaringan ini.', "warning");
    return;
  }
  try {
    if(btn){ btn.disabled = true; btn.innerText = 'Claiming...'; }
    showToast('‚è≥ Mengirim transaksi faucet...', 'info');

    const faucet = new ethers.Contract(FAUCET_CONTRACT, FAUCET_ABI, signer);
    const tx = await faucet.faucet();
    await tx.wait();

    showToast('üéâ Faucet berhasil! Token KN ditambahkan ke wallet Anda.', "success");
    await updateBalances();
  } catch(err){
    console.error('claimFaucet error', err);
    let msg = err?.data?.message || err?.error?.message || err?.reason || err.message || "Gagal claim faucet";

    if(msg.toLowerCase().includes("execution reverted")) {
      msg = msg.split("execution reverted:").pop().trim();
    }

    if(msg.toLowerCase().includes("cooldown") || msg.toLowerCase().includes("tunggu")) {
      showToast("‚è≥ " + msg, "warning");
    } else {
      showToast("‚ùå " + msg, "error");
    }
  } finally {
    if(btn){ btn.disabled = false; btn.innerText = 'Claim Faucet'; }
  }
}

// ========== LISTEN WALLET EVENTS ==========
if(window.ethereum){
  window.ethereum.on('accountsChanged', async (accs) => {
    if(!accs || accs.length === 0){
      userAddress = null; provider = null; signer = null;
      setConnectedState(false);
      document.getElementById('bnbBalance').innerText = '0 BNB';
      document.getElementById('tokenBalance').innerText = '0 KN';
      document.getElementById('totalStaked') && (document.getElementById('totalStaked').innerText='0 KN');
      document.getElementById('pendingReward') && (document.getElementById('pendingReward').innerText='0 KN');
      return;
    }
    userAddress = accs[0];
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    setConnectedState(true);
    await updateBalances(); if(BSC_CHAIN_ID==='0x61'){ await updateStaked(); await updateReward(); }
  });
  window.ethereum.on('chainChanged', () => { setTimeout(()=>location.reload(), 200); });
}

// ========== INIT ==========
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('networkSwitcher').value = 'testnet';
  switchNetwork('testnet');
  setConnectedState(false);
  const hash = location.hash?.replace('#','') || 'home';
  showPage(hash);
  document.getElementById('contractAddr').innerText = KN || '';
});
</script>
</body>
</html>
